<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üü® Splendor Leaderboard</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=MedievalSharp&family=Poppins:wght@400;600;700&display=swap');

/* üéØ Score breakdown tooltip */
.score-cell{
  position:relative;
  cursor:help;
}
.tooltip{
  position:absolute;
  bottom:120%;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,0.85);
  color:#fff;
  padding:10px 12px;
  border-radius:10px;
  font-size:0.8rem;
  white-space:pre-line;
  width:260px;
  display:none;
  z-index:100;
}
.score-cell:hover .tooltip{display:block;}

:root{
  --bg1:#1b5e20; --bg2:#2e7d32; --bg3:#c9a227; --bg4:#f5e27a;
  --text:#fffbe6; --glass:rgba(255,255,255,0.15);
  --gold:#ffd700; --silver:#c0c0c0; --bronze:#cd7f32;
}

body.dark-mode{
  --bg1:#0f3d1f; --bg2:#145a32; --bg3:#8e6f14; --bg4:#2c2c2c;
  --glass:rgba(0,0,0,0.45);
}

body{
  margin:0;
  font-family:'Poppins',sans-serif;
  color:var(--text);
  background:linear-gradient(-45deg,var(--bg1),var(--bg2),var(--bg3),var(--bg4));
  background-size:400% 400%;
  animation:gradientShift 20s ease infinite;
}

@keyframes gradientShift{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}

h1{
  text-align:center;
  margin:45px 0 10px;
  font-family:'MedievalSharp',cursive;
  font-size:3rem;
  cursor:pointer;
}

.controls{text-align:center;margin-bottom:15px;}

button{
  background:rgba(0,0,0,0.35);
  color:#fff;
  border:1px solid rgba(255,255,255,0.3);
  padding:8px 14px;
  border-radius:20px;
  cursor:pointer;
  margin:4px;
}

.leaderboard{
  width:92%;
  max-width:950px;
  margin:auto;
  background:var(--glass);
  border-radius:22px;
  backdrop-filter:blur(14px);
  overflow:hidden;
}

table{width:100%;border-collapse:collapse;}
th,td{padding:16px;text-align:center;vertical-align:top;}
thead{background:rgba(255,255,255,0.25);}

tr{transition:0.3s ease;}
tr:hover{background:rgba(255,255,255,0.15);}

.rank-1 td{color:var(--gold);font-weight:700}
.rank-2 td{color:var(--silver)}
.rank-3 td{color:var(--bronze)}

footer{text-align:center;margin:25px;opacity:0.85;font-size:0.9rem;}

#formulaBtn{
  position:fixed;
  bottom:20px;
  right:20px;
  width:54px;
  height:54px;
  border-radius:50%;
  font-size:22px;
}

#formulaPanel{
  position:fixed;
  bottom:90px;
  right:20px;
  width:360px;
  background:var(--glass);
  backdrop-filter:blur(16px);
  border-radius:18px;
  padding:18px;
  display:none;
  text-align:left;
  z-index:10;
}

#formulaPanel code{
  display:block;
  background:rgba(0,0,0,0.35);
  padding:12px;
  border-radius:10px;
  margin:10px 0;
  font-size:0.85rem;
  white-space:pre-line;
}

small.muted{opacity:0.8}
small.rivalry{
  display:block;
  margin-top:6px;
  font-size:0.75rem;
  opacity:0.9;
}
</style>
</head>

<body class="dark-mode">

<h1 id="title">üü® Splendor Leaderboard</h1>

<div class="controls">
  <button id="themeBtn">üåô</button>
</div>

<div class="leaderboard">
<table>
<thead>
<tr>
  <th>Rank</th>
  <th>Player</th>
  <th>Score</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<footer>
  <div id="lore"></div>
  <div id="funFact"></div>
  <div>Last updated: <span id="time"></span></div>
</footer>

<button id="formulaBtn">üìò</button>

<div id="formulaPanel">
  <h3>üßÆ How scoring works (per game)</h3>
  <code>
(final_points √ó 10)
+ (point_cards √ó 2)
+ (nobles √ó 5)
‚àí (reserved_cards √ó 2)
‚àí max(0, total_cards ‚àí 15)
  </code>
  <small class="muted">üèÜ Only your <b>top 3 games</b> count.</small>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSzp7jnhCy8rnh7A604KCJHKLNw0CY20C858GOyvBOrhMVlKqKUKPzYTgO0l4so8iLhqFbuQehSSg6N/pub?output=csv";

const facts=[
"üíé Diamonds are temporary. Screenshots are eternal.",
"üòå Only top 3 games count. The rest build character.",
"üé≠ Rules may change based on Host's mood.",
"ü™ô Splendor is 50% skill, 50% blaming the deck.",
"üëÄ Someone always *almost* wins."
];

function computeScore(r){
  return (r.final_points*10)
    + (r.point_cards*2)
    + (r.nobles*5)
    - (r.reserved_cards*2)
    - Math.max(0, r.total_cards-15);
}

async function load(){
  const res=await fetch(CSV_URL+"&t="+Date.now());
  const txt=(await res.text()).replace(/^\uFEFF/,"");
  const lines=txt.trim().split("\n");

  const delimiter =
    lines[0].includes(",") ? "," :
    lines[0].includes(";") ? ";" :
    "\t";

  const h=lines[0].split(delimiter).map(x=>x.trim());
  const i=k=>h.indexOf(k);
  const num=v=>Number(v)||0;

  const rows=lines.slice(1).map(r=>{
    const c=r.split(delimiter);
    return {
      game:c[i("gameid")],
      name:c[i("player_name")],
      final_points:num(c[i("final_points")]),
      point_cards:num(c[i("point_cards")]),
      total_cards:num(c[i("total_cards")]),
      reserved_cards:num(c[i("reserved_cards")]),
      nobles:num(c[i("nobles")])
    };
  });

  const byPlayer={};
  rows.forEach(r=>{
    const score=computeScore(r);
    byPlayer[r.name]??=[];
    byPlayer[r.name].push({...r,score});
  });

  const players=Object.entries(byPlayer).map(([name,games])=>{
    games.sort((a,b)=>b.score-a.score);
    const top=games.slice(0,3);
    return {
      name,
      top,
      score:top.reduce((a,b)=>a+b.score,0)
    };
  }).sort((a,b)=>b.score-a.score);

  const tbody=document.getElementById("tbody");
  tbody.innerHTML="";

  players.forEach((p,i)=>{
    const breakdown=p.top.map(g=>
      `Game ${g.game}: ${g.score}
(${g.final_points}√ó10 + ${g.point_cards}√ó2 + ${g.nobles}√ó5 ‚àí ${g.reserved_cards}√ó2 ‚àí ${Math.max(0,g.total_cards-15)})`
    ).join("\n\n");

    let rivalry="";
    if(i<3){
      const above=players[i-1];
      const below=players[i+1];

      if(above && Math.abs(p.score-above.score)<=3){
        rivalry=`<small class="rivalry">üò¨ ${above.score-p.score} pt behind ${above.name}</small>`;
      }
      if(below && Math.abs(p.score-below.score)<=3){
        rivalry=`<small class="rivalry">üî• ${p.score-below.score} pt ahead of ${below.name}</small>`;
      }
    }

    const tr=document.createElement("tr");
    tr.className=`rank-${i+1}`;

    tr.innerHTML=`
      <td>
        ${i+1}
        ${rivalry}
      </td>
      <td>${p.name}</td>
      <td class="score-cell">
        ${p.score}
        <div class="tooltip">${breakdown}</div>
      </td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("funFact").textContent =
    facts[Math.floor(Math.random()*facts.length)];
  document.getElementById("lore").textContent =
    `üè∞ ${players[0].name} currently dominates the gem market.`;
  document.getElementById("time").textContent=new Date().toLocaleString();
}

document.getElementById("themeBtn").onclick=()=>{
  document.body.classList.toggle("dark-mode");
};
document.getElementById("formulaBtn").onclick=()=>{
  const p=document.getElementById("formulaPanel");
  p.style.display=p.style.display==="block"?"none":"block";
};

let clicks=0;
document.getElementById("title").onclick=()=>{
  if(++clicks===3)
    alert("üòà Cutie & Cairo reserve the right to change any rules.");
};

load();
setInterval(load,30000);
</script>

</body>
</html>
